machine:
  node:
    version: stable
  timezone:
    Australia/Brisbane
  environment:
    NODE_ENV: 'development'
  pre:
    - mkdir ~/.yarn-cache
  post:
    - curl -o- -L https://yarnpkg.com/install.sh | bash
    - yarn config set cache-folder ~/.yarn-cache
    - curl -sL https://sentry.io/get-cli/ | bash
    - aws configure set preview.cloudfront true

general:
  artifacts:
    - dist/

database:
  override:
    - echo 'No database'

dependencies:
  cache_directories:
    - ~/.yarn-cache
  override:
    - yarn install --pure-lockfile
  post:
    - yarn add node-sass --dev --force # Force a re-install of node-sass becuase of the binary fails

test:
  pre:
    - yarn lint:ts
    - yarn lint:scss
  override:
    - yarn test

compile:
  override:
    - yarn build

deployment:
  production:
    branch: release
    commands:
      - sentry-cli releases new "$CIRCLE_BUILD_NUM"
      - sentry-cli releases set-commits "$CIRCLE_BUILD_NUM" --auto
      - yarn deploy
      - sentry-cli releases files "$CIRCLE_BUILD_NUM" upload-sourcemaps dist/ --ext map
      - sentry-cli releases finalize "$CIRCLE_BUILD_NUM"
      - sentry-cli releases deploys "$CIRCLE_BUILD_NUM" new -e prod
      - aws cloudfront create-invalidation --distribution-id $AWS_DISTRO --paths /*.js /*.css /*.html /sitemap.en_AU.xml /resume.json
